{% extends 'Tasks/layout.html' %}

{% block body %}
<div class="container">
    <div style='margin-bottom: 30px;'>
        <div class="header-container" style="margin-top:90px;">
            <a href='{% url 'calendar' %}'>< back </a>
            <div class="btn-group">
                <a href="{% url 'calendar' %}" class="btn btn-primary" aria-current="page">Month</a>
                <a href="#" class="btn btn-primary active" aria-current="page">Day</a>
            </div>
        </div>
    </div>
    
        <div class="header-container">
            <div id="day_head">
                <h1 style="margin-bottom: 0;"><strong>{{ header_date.date|date:"j M" }}</strong> {{ header_date.date|date:"Y" }}</h1>
                <h4 style="margin-bottom: 20px; margin-top: 0;">{{ header_date.date|date:"l" }}<h4>
                <div class="btn-group">
                    {% if yesterday_id > 0 %}
                        <a href="{% url 'day_view' yesterday_id %}" class="btn btn-primary" aria-current="page"> < </a>
                    {% endif %}
                    {% if tomorrow_id < 43 %}
                    <a href="{% url 'day_view' tomorrow_id %}" class="btn btn-primary" aria-current="page"> > </a>
                    {% endif %}
                </div>
            </div>
            <div class="header-container">
                <h3 style="margin-bottom: 15px;"> <strong>{{month}}</strong> {{year}} </h3>
                <button class="blue_btn submit_btn" data-bs-target="#NewEventModalToggle" data-bs-toggle="modal" id="eventAdder">+ Add</button>
            </div>
        </div>

        <div class="modal" id="NewEventModalToggle" tabindex="-1" aria-labelledby="NewEventModalToggleLabel">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
              <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title mont-bold">New Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form action="{% url 'new_event' %}" id="newEventForm" method="post">
                    {% csrf_token %}
                      <div class="modal-body">
                        <div class="fieldWrapper" id="eventTitle">
                          <label class="mont-bold" for="{{ form.title.id_for_label }}">Title:</label>
                          {{form.title}}
                        </div>
                        <div class="fieldWrapper" id="endTime">
                          <label for="{{ form.title.id_for_label }}" class="mont-bold">Date: </label>
                          {{form.date}}
                        </div>
                        <div class="fieldWrapper" id="endTime">
                          <label class="mont-bold" for="{{ form.title.id_for_label }}">Start time: </label>
                          {{form.start_time}}
                        </div>
                        <div class="fieldWrapper">
                          <label class="mont-bold" for="{{ form.title.id_for_label }}">End time: </label>
                          {{form.end_time}}
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <input type="submit" class="btn btn-primary">
                      </div>
                  </form>
              </div>
            </div>
          
          </div>
    
        
    <div class="scroll_container" id="dayViewContainer">
    </div>
</div>

<script type="text/babel">
    // Parse in day's JSON data
    const dayData = JSON.parse('{{ day|safe }}');
    // Render dayView React component
    ReactDOM.render(<Day dayEvents={dayData.events} />, document.querySelector('#dayViewContainer'));

    // Scroll to the 6AM on initial render
    document.getElementById('list-item-24').scrollIntoView();

    function find_nearestMinutes(minute) {
        const quarters = [0,15,30,45,60];
        // Find absolute differences between 'quarters' values and the minute
        const calc = quarters.map(n => Math.abs(n - minute));
        const minDistance = Math.min(...calc); // '...' spread syntax passes the array of numbers as seperate numbers
        const closestIndex = calc.indexOf(minDistance);
        let closest_min = quarters[closestIndex];
        closest_min = String(closest_min);
        
        // Return the 'minute' string
        return closest_min;
    }

    function visual_TimeFinder(hour, nearest_found_mins) {
        const nearest_fifteen = nearest_found_mins;
        let starting_minute = '';
        let starting_hour = hour;
        
        if (nearest_fifteen == 60) {
            starting_hour = hour + 1;
            starting_minute = '00';
        } else if (nearest_fifteen == 0) {
            starting_hour = hour;
            starting_minute = "00";
        } else {
            starting_hour = hour;
            starting_minute = String(nearest_fifteen);
        }

        const visualStartTime = String(starting_hour) + ":" + starting_minute;
        
        return visualStartTime;
    }

    function get_VisualPoints(event) {
        // Get start time
        let start_time = event.start_time;
        let st_minute = start_time.split(':')[1];
        st_minute = Number(st_minute);
        let st_hour = start_time.split(':')[0];
        st_hour = Number(st_hour);
        const nearest_st_min = find_nearestMinutes(st_minute);
        // Find nearest 15 min block to start time
        // So can start visual event here.
        // (dayViewContainer rendered in 15 min blocks)
        const visualStartTime = visual_TimeFinder(st_hour, nearest_st_min);
        // Get end time
        let end_time = event.end_time;
        let et_minute = end_time.split(':')[1];
        et_minute = Number(et_minute);
        let et_hour = end_time.split(':')[0];
        et_hour = Number(et_hour);
        const nearest_et_min = find_nearestMinutes(et_minute);
        // Find nearest 15 min block to start time
        // So can start visual event here.
        // (dayViewContainer rendered in 15 min blocks)
        const visualEndTime = visual_TimeFinder(et_hour, nearest_et_min);
        return [visualStartTime, visualEndTime];
    }

    // Render events to the dayViewContainer
    function renderEvents() {
        const events = dayData.events;

        for (const event of events) {
            let visualStartTime = get_VisualPoints(event)[0];
            let visualEndTime = get_VisualPoints(event)[1];
            console.log("Event: ", event);
            console.log("Start: ", visualStartTime);
            console.log("End: ", visualEndTime);

             // Find the divs corresponding to the start and end times
            const startDiv = document.getElementById(`hr_${visualStartTime.split(":")[0]}-min_${visualStartTime.split(":")[1]}`);
            const endDiv = document.getElementById(`hr_${visualEndTime.split(":")[0]}-min_${visualEndTime.split(":")[1]}`);
            
            // Iterate over the divs between start and end times
            let currentDiv = startDiv.nextElementSibling;
            // Add title to top of event (First one after start time)
            currentDiv.innerHTML = `<h5 class="event-title">${event.title}</h5>`;
            while (currentDiv !== endDiv) {
                // Update inner HTML and adjust CSS styling
                currentDiv.classList.add('calendar-event');
                currentDiv.classList.add('event-side-border');
                currentDiv = currentDiv.nextElementSibling;
            }

        }


    }

    renderEvents();
</script>
{% endblock %}